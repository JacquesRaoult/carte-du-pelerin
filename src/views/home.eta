<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carte du P√®lerin</title>
    <link rel="icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="/css/global.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <script src="https://cdn.counter.dev/script.js" data-id="435f1c20-b9e5-41ba-bcb9-531b52e12138" data-utcoffset="1"></script>
</head>

<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h1>üó∫Ô∏è Carte du P√®lerin</h1>
                <p>D√©couvrez les points d'int√©r√™t autour de vous</p>
            </div>

            <div class="search-box">
                <input type="text" class="search-input" id="searchInput" placeholder="üîç Rechercher un lieu...">
            </div>

            <div class="filters">
                <h3>Cat√©gories</h3>
                <div class="filter-buttons">
                    <button class="filter-btn active" data-category="all">Tous</button>
                    <button class="filter-btn" data-category="Lieu remarquable">Lieu remarquable</button>
                    <button class="filter-btn" data-category="Relique du Christ">Relique du Christ</button>
                    <button class="filter-btn" data-category="Relique ou p√®lerinage marial">Relique ou p√®lerinage marial</button>
                    <button class="filter-btn" data-category="Relique ou p√®lerinage">Relique ou p√®lerinage</button>
                </div>
            </div>

            <div class="poi-list" id="poiList"></div>
        </div>

        <!-- Map -->
        <div class="map-container">
            <button class="menu-toggle" id="menuToggle">‚ò∞</button>
            <div class="stats-bar">
                <span id="poiCount">0</span> points d'int√©r√™t affich√©s
            </div>
            <div id="map"></div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle"></h2>
                <button class="modal-close" id="modalClose">&times;</button>
                <span class="modal-category" id="modalCategory"></span>
            </div>
            <div class="modal-body">
                <div class="modal-description" id="modalDescription"></div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/11.1.1/marked.min.js"></script>

    <script>

        let map;
        let markersLayer;
        let pois = [];
        let currentCategory = 'all';
        let searchTerm = '';

        // Markdown config
        marked.setOptions({ breaks: true, gfm: true });

        // Labels : ici on mappe proprement tes cat√©gories
        function getCategoryLabel(category) {
            const labels = {
                'Lieu remarquable': 'Lieu remarquable',
                'Relique du Christ': 'Relique du Christ',
                'Relique ou p√®lerinage marial': 'Relique ou p√®lerinage marial',
                'Relique ou p√®lerinage': 'Relique ou p√®lerinage'
            };
            return labels[category] || category;
        }

        // Modal
        function openModal(poi) {
            document.getElementById('modalTitle').textContent = poi.name;
            document.getElementById('modalCategory').textContent = getCategoryLabel(poi.category);
            document.getElementById('modalDescription').innerHTML = marked.parse(poi.fullDescription || '');
            document.getElementById('modalOverlay').classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        function closeModal() {
            document.getElementById('modalOverlay').classList.remove('active');
            document.body.style.overflow = '';
        }
        document.getElementById('modalClose').onclick = closeModal;
        document.getElementById('modalOverlay').onclick = (e) => {
            if (e.target.id === 'modalOverlay') closeModal();
        };
        document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

        // Map
        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([46.5, 2.5], 6);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);
            markersLayer = L.layerGroup().addTo(map);
        }

        // Load GeoJSON
        async function loadGeoJSON() {
            try {
                const response = await fetch('https://www.carte-du-pelerin.com/api/geojson');
                const geojson = await response.json();

                pois = geojson.features.map((feature, index) => {
                    const props = feature.properties || {};

                    const category = props.category || '';

                    let cleanDesc = props.description || '';
                    cleanDesc = cleanDesc
                        .replace(/üö©|üìú|üìö|üìù|üì∑|üîó|##|\*\*|{{.*?}}|\[\[.*?\]\]/g, '')
                        .split('\n')
                        .filter(l => l.trim())
                        .slice(0, 3)
                        .join(' ')
                        .substring(0, 200);

                    return {
                        id: feature.id || index,
                        name: props.name || 'Sans nom',
                        description: cleanDesc,
                        fullDescription: props.description || '',
                        category: category,
                        coordinates: feature.geometry.coordinates
                    };
                });

                updatePoiList();
                updateMap();

            } catch (error) {
                console.error('Erreur GeoJSON :', error);
                alert('Impossible de charger les donn√©es.');
            }
        }

        // Filter system
        function getFilteredPois() {
            return pois.filter(poi => {
                const matchCategory = currentCategory === 'all' || poi.category === currentCategory;
                const matchSearch = poi.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                    poi.description.toLowerCase().includes(searchTerm.toLowerCase());
                return matchCategory && matchSearch;
            });
        }

        // Map update
        function updateMap() {
            markersLayer.clearLayers();
            const filteredPois = getFilteredPois();

            filteredPois.forEach(poi => {
                const [lng, lat] = poi.coordinates;

                const marker = L.marker([lat, lng]).bindPopup(`
                    <div class="popup-title">${poi.name}</div>
                    <span class="popup-category">${getCategoryLabel(poi.category)}</span>
                    <div class="popup-description">${poi.description}</div>
                    <button onclick="openModalFromMap(${poi.id})" style="margin-top:10px; padding:8px 16px; background:#3498db; color:white; border:none; border-radius:5px; cursor:pointer;">Voir d√©tails</button>
                `);

                markersLayer.addLayer(marker);
            });

            if (filteredPois.length > 0) {
                const bounds = L.latLngBounds(
                    filteredPois.map(poi => [poi.coordinates[1], poi.coordinates[0]])
                );
                map.fitBounds(bounds, { padding: [50, 50] });
            }
        }

        window.openModalFromMap = (id) => {
            const poi = pois.find(p => p.id === id);
            if (poi) openModal(poi);
        };

        // POI list
        function updatePoiList() {
            const filteredPois = getFilteredPois();
            const poiList = document.getElementById('poiList');

            poiList.innerHTML = filteredPois.map(poi => `
                <div class="poi-item" data-id="${poi.id}">
                    <h4>${poi.name}</h4>
                    <span class="poi-category">${getCategoryLabel(poi.category)}</span>
                    <p>${poi.description}</p>
                </div>
            `).join('');

            document.querySelectorAll('.poi-item').forEach(item => {
                item.addEventListener('click', () => {
                    const poi = pois.find(p => p.id == item.dataset.id);
                    if (poi) openModal(poi);
                });
            });

            document.getElementById('poiCount').textContent = filteredPois.length;
        }

        // Filters
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.onclick = () => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentCategory = btn.dataset.category;
                updatePoiList();
                updateMap();
            };
        });

        // Search
        document.getElementById('searchInput').oninput = (e) => {
            searchTerm = e.target.value;
            updatePoiList();
            updateMap();
        };

        // Mobile toggle
        document.getElementById('menuToggle').onclick = () =>
            document.getElementById('sidebar').classList.toggle('active');

        initMap();
        loadGeoJSON();

    </script>
</body>
</html>
